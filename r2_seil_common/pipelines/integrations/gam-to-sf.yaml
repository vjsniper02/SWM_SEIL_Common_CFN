trigger: none
pool:
  vmImage: ubuntu-20.04

parameters:
  - name: env
    displayName: Environment
    type: string
    values:
      - apidev
      - etldev
      - sit
      - uat
      - prod
  - name: services
    displayName: Services to build
    type: object
    default:
      - delivery-reporting
  - name: costCenter
    displayName: "Tag: Cost Center"
    type: string
    default: "7IT"
    values:
      - 7IT
  - name: project
    displayName: "Tag: Project"
    type: string
    default: "SWM Integration"
  - name: role
    displayName: "Tag: Role"
    type: string
    default: "Azure DevOps pipeline"
  - name: repository
    displayName: "Tag: Repository"
    type: string
    default: "SWM Integration"
  - name: criticality
    displayName: "Tag: Criticality"
    type: string
    default: "Critical"
    values:
      - Critical
      - High
      - Medium
      - Low
  - name: pii
    displayName: "Tag: PII"
    type: string
    default: "no"
    values:
      - yes
      - no
  - name: securityClassification
    displayName: "Tag: Security Classification"
    type: string
    default: "Critical"
    values:
      - Critical
      - High
      - Medium
      - Low


variables:
  - name: serviceConnection
    ${{ if in(parameters.env, 'apidev', 'etldev') }}:
      value: AwsDev
    ${{ elseif in(parameters.env, 'uat', 'sit') }}:
      value: AwsNonProd
    ${{ elseif in(parameters.env, 'prod') }}:
      value: AwsProd
  - name: region
    value: ap-southeast-2

stages:
  - ${{ each service in parameters.services }}:
      - stage: ${{ replace(service, '-', '_') }}
        displayName: Deploy ${{ service }} Lambda
        jobs:
          - template: ../templates/lambda-build.yaml
            parameters:
              lambda: gam-to-sf/${{ service }}
              env: ${{ parameters.env }}
              serviceConnection: ${{ variables.serviceConnection }}
          - job: updateStack
            displayName: Deploy ${{ service }} Lambda Stack
            dependsOn: buildDeploy
            variables:
              lambdaVersion: $[ dependencies.buildDeploy.outputs['outputVersion.lambdaVersion'] ]
            steps:
              - task: CloudFormationCreateOrUpdateStack@1
                displayName: Update Stack
                inputs:
                  awsCredentials: ${{ variables.serviceConnection }}
                  regionName: ${{ variables.region }}
                  stackName: ${{ parameters.env }}-gam-to-sf-${{ service }}
                  capabilityIAM: true
                  capabilityNamedIAM: true
                  capabilityAutoExpand: true
                  templateFile: cfn/templates/gam-to-sf/${{ service }}.yaml
                  templateParametersSource: inline
                  templateParameters: |
                    - ParameterKey: EnvPrefix
                      ParameterValue: ${{ parameters.env }}
                    - ParameterKey: LambdaVersion
                      ParameterValue: $(lambdaVersion)
                  tags: |
                    CostCenter=${{ parameters.costCenter }}
                    Environment=${{ parameters.env }}
                    IACReleaseNumber=$(Build.SourceVersion)
                    LastUpdatedBy=$(Build.QueuedBy)
                    Project=${{ parameters.project }}
                    Role=${{ parameters.role }}
                    Repository=${{ parameters.repository }}
                    Criticality=${{ parameters.criticality }}
                    PII=${{ parameters.pii }}
                    SecurityClassification=${{ parameters.securityClassification }}